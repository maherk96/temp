```sql

-- Step 1: Create new TAG table
CREATE TABLE QAPORTAL.TAG (
    ID NUMBER(19,0) GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NAME VARCHAR2(50 CHAR) UNIQUE NOT NULL
)
TABLESPACE QAPORTAL_DATA;

-- Step 2: Add TAG_ID column to TEST_TAG
ALTER TABLE QAPORTAL.TEST_TAG ADD (TAG_ID NUMBER(19,0));

-- Step 3: Populate TAG table with distinct tag values
INSERT INTO QAPORTAL.TAG (NAME)
SELECT DISTINCT TAG
FROM QAPORTAL.TEST_TAG
WHERE TAG IS NOT NULL;

-- Step 4: Update TEST_TAG.TAG_ID based on TAG.NAME
UPDATE QAPORTAL.TEST_TAG tt
SET TAG_ID = (
    SELECT t.ID FROM QAPORTAL.TAG t
    WHERE t.NAME = tt.TAG
)
WHERE tt.TAG IS NOT NULL;

-- Step 5: Add foreign key constraint
ALTER TABLE QAPORTAL.TEST_TAG
ADD CONSTRAINT FK_TAG_TESTTAG
FOREIGN KEY (TAG_ID)
REFERENCES QAPORTAL.TAG(ID);

-- Step 6: (Optional) Drop old TAG column after verification
-- ALTER TABLE QAPORTAL.TEST_TAG DROP COLUMN TAG;

-- Should return 0 if all tags migrated properly
SELECT COUNT(*) AS unmapped_tags
FROM QAPORTAL.TEST_TAG
WHERE TAG IS NOT NULL AND TAG_ID IS NULL;

-- Check new tag table
SELECT * FROM QAPORTAL.TAG FETCH FIRST 10 ROWS ONLY;

-- Check sample mappings
SELECT tt.TAG, t.NAME
FROM QAPORTAL.TEST_TAG tt
JOIN QAPORTAL.TAG t ON tt.TAG_ID = t.ID
FETCH FIRST 10 ROWS ONLY;
```
